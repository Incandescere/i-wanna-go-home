name: Lambda update

on: 
  push:
    branches: ["infra"]

permissions:
  id-token: write
  contents: read

jobs:
  aws:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch full history for git diff

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.OIDC_IAM_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Fetch infra branch for diff
        run: git fetch origin infra

      - name: Check if reminder file updated
        id: check_reminder_changed
        run: |
          if git diff --name-only origin/infra...HEAD | grep -q '^iwgh/ap-southeast-1/iwgh-lambda-reminder/lambda/src'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if subscription file updated
        id: check_subscription_changed
        run: |
          if git diff --name-only origin/infra...HEAD | grep -q '^iwgh/ap-southeast-1/iwgh-lambda-subscription/lambda/src'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Reminder Lambda
        if: steps.check_reminder_changed.outputs.changed == 'true'
        run: |
          cd iwgh/ap-southeast-1/iwgh-lambda-reminder/lambda/src
          zip -r iwgh-lambda-reminders.zip .
          aws lambda update-function-code \
            --function-name iwgh-lambda-reminders \
            --zip-file fileb://iwgh-lambda-reminders.zip

      - name: Update Subscription Lambda
        if: steps.check_subscription_changed.outputs.changed == 'true'
        run: |
          cd iwgh/ap-southeast-1/iwgh-lambda-subscription/lambda/src
          zip -r iwgh-lambda-subscription.zip .
          aws lambda update-function-code \
            --function-name iwgh-lambda-subscription \
            --zip-file fileb://iwgh-lambda-subscription.zip
